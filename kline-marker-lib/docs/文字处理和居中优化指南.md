# K线标记文字处理和居中优化指南

## 概述

本指南介绍了K线标记库中新增的文字处理和居中优化功能，主要包括：

1. **文字长度限制** - 自动限制有形状标记的文字为最多一个字符
2. **汉字居中优化** - 特别优化汉字在标记中的垂直居中显示
3. **TEXT ONLY 例外** - 纯文字标记（NONE形状）保持多字符支持

## 文字长度限制规则

### 基本规则

| 标记形状 | 文字限制 | 大小特点 | 示例 |
|----------|----------|----------|------|
| 圆形 (CIRCLE) | 1个字符 | 固定大小，不受文字影响，默认16dp | "买卖操作" → "买" |
| 矩形 (RECTANGLE) | 1个字符 | 固定16dp直角正方形 | "ABCD" → "A" |
| 菱形 (DIAMOND) | 1个字符 | 动态大小，适应文字，默认16dp | "123456" → "1" |
| 三角形 (TRIANGLE) | 1个字符 | 动态大小，适应文字，默认16dp | "!!!警告" → "!" |
| 箭头 (ARROW) | 1个字符 | 动态大小，适应文字，默认16dp | "箭头文字" → "箭" |
| 星形 (STAR) | 1个字符 | 动态大小，适应文字，默认16dp | "☀☁☂☃" → "☀" |
| 圆点 (DOT) | 无文字 | 固定4dp小尺寸 | - |
| 文字 (NONE) | 多字符 | 适应文字长度 | 支持完整文本 |

### 字符截取规则

```java
// 支持的字符类型：
"汉字测试"     → "汉"     // 汉字
"English"     → "E"      // 英文
"12345"       → "1"      // 数字
"αβγδε"       → "α"      // 希腊字母
"☀☁☂☃"       → "☀"      // 特殊符号
"🚀🎯📈"       → "🚀"     // Emoji表情
```

## 汉字居中优化

### 问题背景

原始的文字居中算法主要基于英文字符设计，对于汉字等方块字符存在以下问题：

1. **垂直偏移** - 汉字显示位置偏上或偏下
2. **基线计算不准确** - 没有考虑汉字的特殊基线特征
3. **不同字体的差异** - 各种字体的汉字基线位置不同

### 优化方案

新的汉字居中算法采用以下改进：

```java
/**
 * 改进的汉字文字居中算法
 * 特别优化汉字的垂直居中显示
 */
public static float calculateChineseTextBaselineY(Paint textPaint, String text, float centerY) {
    if (text == null || text.isEmpty()) {
        return centerY;
    }

    // 获取字体度量信息
    Paint.FontMetrics fontMetrics = textPaint.getFontMetrics();
    
    // 检测是否包含汉字
    boolean hasChineseChar = containsChineseCharacter(text);
    
    if (hasChineseChar) {
        // 汉字优化算法：使用字体的真实高度中心
        float textHeight = fontMetrics.descent - fontMetrics.ascent;
        return centerY - fontMetrics.ascent - textHeight / 2f + textHeight / 2f;
    } else {
        // 英文/数字算法：基于基线计算
        float textHeight = fontMetrics.descent - fontMetrics.ascent;
        return centerY + textHeight / 2f - fontMetrics.descent;
    }
}
```

### 渲染质量优化

所有文字渲染器都启用了以下优化设置：

```java
textPaint.setSubpixelText(true);    // 子像素文字渲染
textPaint.setLinearText(true);      // 线性文字渲染
textPaint.setAntiAlias(true);       // 抗锯齿
```

## 圆形标记大小统一

### 功能特点

从v3.3.3版本开始，圆形标记使用固定大小，确保视觉一致性：

- **固定半径**：`radius = markerSize * density / 2f`
- **不受文字影响**：无论是中文、英文、数字，圆形大小都一致
- **配置简单**：通过`markerSize`统一控制所有圆形标记的大小

### 设计对比

```java
// 修改前：动态大小（已废弃）
"买" → 较大圆形（因为汉字宽）
"B" → 中等圆形（因为字母窄） 
"1" → 较小圆形（因为数字最窄）

// 修改后：固定大小（当前版本）
"买" → 16dp圆形（默认大小）
"B" → 16dp圆形（默认大小）
"1" → 16dp圆形（默认大小）
```

### 使用建议

```java
// 推荐：使用预设配置（自动16dp）
MarkerConfig circleConfig = MarkerPresets.googleBlue();  // 自动16dp圆形

// 不同内容，相同大小
MarkerData.createCustomMarker(date, "买", circleConfig);  // 16dp圆形
MarkerData.createCustomMarker(date, "B", circleConfig);   // 16dp圆形  
MarkerData.createCustomMarker(date, "1", circleConfig);   // 16dp圆形

// 如需自定义大小
MarkerConfig customConfig = new MarkerConfig.Builder()
    .shape(MarkerShape.CIRCLE)
    .markerSize(20f)  // 自定义为20dp
    .textSize(12f)    // 相应调整文字大小
    .build();
```

### 优势说明

1. **视觉一致性**：所有圆形标记大小统一，避免视觉混乱
2. **易于对齐**：标记之间更容易保持整齐的布局
3. **性能提升**：无需动态计算文字尺寸，渲染更高效
4. **配置简化**：只需设置一个`