# K线图趋势区间阴影功能

## 功能概述

为MPAndroidChart K线图实现了**精致的趋势区间阴影效果**，能够自动检测连续上涨或下跌区间，并绘制沿K线走势的自然阴影背景。

## 主要特性

### 1. 自动检测趋势区间

- **连续上涨检测**：连续3个或以上的上涨K线会被标记为上涨区间
- **连续下跌检测**：连续3个或以上的下跌K线会被标记为下跌区间
- **智能区间管理**：每个趋势区间都有唯一的ID，支持多个独立趋势区间

### 2. 精致的阴影效果

- **上涨区间阴影**：
    - 上边界：沿着K线高点连接形成平滑走势线（贝塞尔曲线）
    - 下边界：固定在x轴位置
    - 渐变：三色渐变 (透明 → 微绿 → 较浓绿色)
    - 偏移：向上偏移10像素，增强视觉效果

- **下跌区间阴影**：
    - 上边界：沿着K线低点连接形成平滑走势线（贝塞尔曲线）
    - 下边界：固定在x轴位置
    - 渐变：三色渐变 (较浓红色 → 微红 → 透明)
    - 偏移：向下偏移10像素，增强视觉效果

- **平滑效果**：使用二次贝塞尔曲线让边界更自然流畅

### 3. 技术实现

#### 核心算法

1. **路径构建**：
    - 使用`Path`类创建自定义形状
    - 从x轴开始，沿着K线的高点/低点收集边界点
    - 使用二次贝塞尔曲线(`quadTo`)平滑连接所有点
    - 回到x轴闭合路径形成填充区域

2. **平滑处理**：
    - 收集所有K线的关键点（高点或低点）
    - 添加适当的偏移量增强视觉效果
    - 使用贝塞尔曲线算法创建平滑的连接线
    - 自动处理起点、中间点和终点的不同连接方式

3. **增强渐变**：
    - 使用三色`LinearGradient`创建更自然的渐变
    - 上涨趋势：顶部透明(0%) → 中部微绿(12%) → 底部较浓绿(31%)
    - 下跌趋势：顶部较浓红(31%) → 中部微红(12%) → 底部透明(0%)
    - 渐变位置可自定义调整

4. **边界适应**：
    - 上边界：精确跟随每个K线的高点或低点
    - 智能偏移：上涨向上偏移10px，下跌向下偏移10px
    - 下边界：始终固定在图表的x轴位置
    - 自动处理图表边界约束

#### 绘制层级

1. **阴影层**：趋势区间阴影（最底层）
2. **数据层**：K线蜡烛图
3. **标记层**：各种标记和指标（最顶层）

### 4. 调试和验证

#### 测试阴影

如果没有检测到自然趋势区间，系统会绘制测试阴影：

- **索引10-15**：模拟上涨趋势阴影（逐渐上升的绿色区域）
- **索引25-30**：模拟下跌趋势阴影（逐渐下降的红色区域）

#### 日志输出

详细的调试信息包括：

- 阴影路径构建过程
- 渐变设置信息
- 每个趋势区间的绘制状态

### 5. 视觉对比

**旧版本（矩形背景）**：

```
┌─────────────────┐
│                 │ 简单矩形
│    K线走势      │ 不跟随走势
│                 │
└─────────────────┘
```

**新版本（精致阴影）**：

```
        ╭──╮    ╭─╮
       ╱    ╲  ╱   ╲     ← 平滑的贝塞尔曲线边界
      ╱      ╲╱     ╲      跟随K线高点/低点
     ╱                ╲
    ╱     渐变阴影      ╲   三色渐变填充  
   ╱      (透明→浓色)    ╲  自然过渡效果
  ╱________________________╲  ← x轴（固定下边界）
```

**关键改进**：

- ✅ 边界跟随K线走势，不再是生硬的矩形
- ✅ 使用贝塞尔曲线，线条更加平滑自然
- ✅ 三色渐变效果，视觉层次更丰富
- ✅ 智能偏移，阴影效果更突出
- ✅ 保持数据可读性，不遮挡重要信息

### 6. 配置参数

- **最小趋势长度**：3个K线（可配置）
- **渐变透明度**：0%-40%（可调整）
- **边界跟踪**：高点/低点自动选择
- **路径平滑**：直线连接（可扩展为曲线）

## 代码结构

```
app/src/main/java/com/alex/mpchart/marker/
├── data/
│   ├── model/
│   │   └── KLineEntry.java           # 趋势区间数据模型
│   └── repository/
│       └── KLineRepository.java      # 趋势检测算法
└── ui/home/
    ├── TrendRegionDrawer.java        # 精致阴影绘制器
    │   ├── drawTrendShadow()         # 沿走势绘制阴影
    │   ├── drawTestTrendShapes()     # 测试阴影形状
    │   └── LinearGradient支持        # 渐变效果
    ├── KLineMarker.java             # 标记绘制器
    └── HomeFragment.java            # 主界面集成
```

## 运行验证

当运行应用时，您将看到：

1. **自然趋势阴影**：
    - 上涨区间：绿色阴影从K线高点向下填充到x轴
    - 下跌区间：红色阴影从K线低点向下填充到x轴

2. **测试阴影**（如果没有自然趋势）：
    - 索引10-15：模拟上升走势的绿色阴影
    - 索引25-30：模拟下降走势的红色阴影

3. **渐变效果**：
    - 所有阴影都有自然的渐变过渡
    - 不会遮挡K线数据的可读性

这个精致的阴影效果为K线图提供了更专业、更直观的趋势可视化体验！ 